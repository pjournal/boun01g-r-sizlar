---
title: "EXIST_2019_IDM*Analysis"
author: "R'sÄ±zlar"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4 
    number_sections: true
    theme: united
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# Introduction  
We have 7 different datasets belonging to Intraday Market of EXIST. All of them are provided for a defined time period which is 2019. 


## Loading the Libraries 

Throughout our analysis, we will make use of some well known R packages as tidyverse, ggplot2, lubridate, etc.

```{r intro}
library(tidyverse)
library(lubridate)
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)

```

## Loading Datasets

This analysis is made according to 7 different datasets from [ Energy Exchange of Turkey (EXIST / EPIAS)](https://seffaflik.epias.com.tr/transparency/piyasalar/gip/gip-agirlikli-ortalama-fiyat.xhtml) .


```{r data}
weighted_average_price <- read.csv("https://github.com/pjournal/boun01g-r-sizlar/blob/gh-pages/1idm-weighted-average-price-01012019-31122019.csv?raw=true")

matching_quantity <- read.csv("https://github.com/pjournal/boun01g-r-sizlar/blob/gh-pages/2IDMMatchingQuantity-01012019-31122019.csv?raw=true")

bid_prices <- read.csv("https://github.com/pjournal/boun01g-r-sizlar/blob/gh-pages/3IDMMinMaxBidPrices-01012019-31122019.csv?raw=true")

offer_prices <- read.csv("https://github.com/pjournal/boun01g-r-sizlar/blob/gh-pages/4IntradayMinMaxOfferPrices-01012019-31122019.csv?raw=true")

bid_offer_quantities <- read.csv("https://github.com/pjournal/boun01g-r-sizlar/blob/gh-pages/5BidOfferQuantities-01012019-31122019.csv?raw=true")

matching_price <- read.csv("https://github.com/pjournal/boun01g-r-sizlar/blob/gh-pages/6IntraDayMinMaxMatchingPrice-01012019-31122019.csv?raw=true")

trade_value <- read.csv("https://github.com/pjournal/boun01g-r-sizlar/blob/gh-pages/7IDMTradeValue-01012019-31122019.csv?raw=true")
```

# Data Preprocessing

To make our data ready to analyze, we will do some rearrangements on our data which will also increase its reproducibility and repeatability. These rearrangements will include:

 - Joining process of all 7 data
 - Omission of some columns which we will not need to use
 - Filtering of data due to necessities
 - Date - Time information is converted to POSIXct format
 - Adding of new columns such as Hour, Day of Week and Month


```{r manipulation}
alfa_data <- matching_quantity %>%
            inner_join(bid_prices, by = "Contract.Name") %>%
            inner_join(offer_prices, by = "Contract.Name") %>%
            inner_join(bid_offer_quantities, by = "Contract.Name") %>%
            inner_join(matching_price, by = "Contract.Name") %>%
            inner_join(trade_value, by = "Contract.Name") %>%
            select(-c("Contract.Type.y", "Contract.Type.x.x", "Contract.Type.y.y",
                      "Contract.Type.x.x.x", "Contract.Type.y.y.y", "Contract.Name")) %>%
            filter(Contract.Type.x == "Hourly") %>%
            select(-Contract.Type.x) 

alfa_data %>%
  glimpse()
```


```{r manipulation2}
beta_data <- weighted_average_price %>% 
  bind_cols(alfa_data) 

beta_data %>%
  glimpse()
```


```{r r manipulation3}
Sys.setlocale("LC_TIME", "C")

idm_data <- beta_data %>% 
  mutate(Date.Time = as.POSIXlt(factor(Date), format="%d.%m.%y")) %>% 
  mutate(Date.Time = update(Date.Time, year = 2019)) %>% 
  mutate(Day.Week = wday(Date.Time,label = TRUE,week_start=1), Month = month(Date.Time),Hour = hour(Date.Time)) %>%
  select(-Date) %>% 
  relocate(Date.Time, 
           Hour, 
           Day.Week, 
           Month, 
           WAP..TL.MWh., 
           Clearing.Quantity..MWh., 
           Min.Bid.Price..TL.MWh.,
           Max..Offer.Price..TL.MWh.,
           Bid.Quantity..MWh.,
           Offer.Quantity..MWh.,
           Min..Matching.Price..TL.MWh.,
           Max..Matching.Price..TL.MWh.,
           Trade.Value..TL.) 

idm_data %>% glimpse()
```

```{r r manipulation3}
idm_data[is.na(idm_data)] <- 0
idm_data$Clearing.Quantity..MWh. <- as.numeric(idm_data$Clearing.Quantity..MWh.)
idm_data$Max..Bid.Price..TL.MWh. <- as.numeric(idm_data$Max..Bid.Price..TL.MWh.)
idm_data$Max..Offer.Price..TL.MWh. <- as.numeric(idm_data$Max..Offer.Price..TL.MWh.)
idm_data$Bid.Quantity..MWh. <- as.numeric(idm_data$Bid.Quantity..MWh.)
idm_data$Offer.Quantity..MWh. <- as.numeric(idm_data$Offer.Quantity..MWh.)
idm_data$Trade.Value..TL. <- as.numeric(idm_data$Trade.Value..TL.)
```

# Exploratory Data Analysis

## IDM Matching Quantity

In this part we made monthly comparison of IDM matching quantities for 2019. 

```{r r monthly matching quantity}

new_dataa <- idm_data %>% select(Month,Clearing.Quantity..MWh.)
monthly_matching_quantity <- new_dataa %>% group_by(Month) %>% summarise(Clearing.Quantity..MWh.= sum(Clearing.Quantity..MWh.))

ggplot(data=monthly_matching_quantity,aes(x=as.factor(Month),y=Clearing.Quantity..MWh.,fill=as.factor(Month)))+
labs(x="Months", y="Matching Quantities in MWh", color="Months", title = "Monthly Matching Quantities") + 
  geom_bar(stat='identity',width=0.9,color='blue')


```


## IDM Daily Matching Quantities

In this part we made daily comparison of IDM matching quantities for 2019.

```{r r daily matching quantity}
new_dataa2 <- idm_data %>% select(Clearing.Quantity..MWh.,Day.Week)
daily_matching_quantity <- new_dataa2 %>% group_by(Day.Week) %>% summarise(Clearing.Quantity..MWh.= sum(Clearing.Quantity..MWh.))

ggplot(data=daily_matching_quantity,aes(x=as.factor(Day.Week),y=Clearing.Quantity..MWh.,fill=as.factor(Day.Week)))+
labs(x="Days", y="Matching Quantities in MWh", color="Days", title = "Daily Matching Quantities") + 
  geom_bar(stat='identity',width=0.9,color='blue')



```

## Monthly IDM Weighted Average Price-MCP-SMP

In this part we made monthly comparison of IDM weighted average prices for 2019. 

```{r r matching quantity}
new_dataa3 <- idm_data %>% select(WAP..TL.MWh.,Month)
monthly_weighted_average_prices <- new_dataa3 %>% group_by(Month) %>% summarise(WAP..TL.MWh.= sum(WAP..TL.MWh.))

ggplot(monthly_weighted_average_prices,aes(x=as.factor(Month),y=WAP..TL.MWh.,fill=as.factor(Month)))+
labs(x="Months", y="Prices in TL", color="Months", title = "Monthly Weighted Average Prices") + 
  geom_bar(stat='identity',width=0.9,color='blue')


```

As seen above, in the second half of the year Monthly Weighted Average Prices went up. Besides, after first quarter, there is a significant drop in the prices.

##IDM Monthly Offer Quantities 

In this part we made monthly comparison of IDM monthly offer quantities for 2019. 

```{r r offer quantity,include=False eval=FALSE}


new_dataa4 <- idm_data %>% select(Offer.Quantity..MWh.,Month)
monthly_offer_quantities <- new_dataa4 %>% group_by(Month) %>% summarise(Offer.Quantity..MWh.= sum(Offer.Quantity..MWh.))

ggplot(monthly_offer_quantities,aes(x=as.factor(Month),y=Offer.Quantity..MWh.,fill=as.factor(Month)))+
labs(x="Months", y="Offer Quantities in MWh", color="Months", title = "Monthly Offer Quantities") + 
  geom_bar(stat='identity',width=0.9,color='blue')

```

## IDM Offer and Matching Quantities 

In this part we made monthly comparison of IDM offer and matching quantities for 2019.


```{r r matching-offer quantity}


new_dataa5 <- idm_data %>% select(Month,Clearing.Quantity..MWh.,Offer.Quantity..MWh.)
monthly_offer_and_matching_quantities <- new_dataa5 %>% group_by(Month) %>% summarise(Clearing.Quantity..MWh.= sum(Clearing.Quantity..MWh.),Offer.Quantity..MWh.=sum(Offer.Quantity..MWh.))

monthly_offer_and_matching_quantities_longer <-
monthly_offer_and_matching_quantities %>%
  ungroup() %>%
  pivot_longer(cols=c(Clearing.Quantity..MWh., Offer.Quantity..MWh.), names_to="Types", values_to="Quantities") %>%
  select(Month,Types,Quantities)

ggplot(monthly_offer_and_matching_quantities_longer, aes(x=Month, y=Quantities, fill=Types)) +
            scale_fill_manual(values=c("coral3", "darkslateblue")) +
            theme_minimal() +
            geom_bar(stat="identity", position="dodge") +
            ggtitle("Average MCP vs SMP Prices per Day of Week") +
            theme(axis.text.x = element_text(angle = 45), legend.position = "top")



```

## IDM Maximum Bid, Offer, Matching Prices 

IDM bid, offer, and matching prices for 2019.

```{r r max bid-offer-matching prices}

```


##  IDM Monthly Trading Volume

In this part we made monthly comparison of IDM traing volume for 2019.

```{r r mothly trading volume}

new_dataa6 <- idm_data %>% select(Month,Trade.Value..TL.)
monthly_trading_volume <- new_dataa6 %>% group_by(Month) %>% summarise(Trade.Value..TL.= sum(Trade.Value..TL.))

ggplot(data=monthly_trading_volume,aes(x=as.factor(Month),y=Trade.Value..TL.,fill=as.factor(Month)))+
geom_line() +
  labs(
    title = "Monthly Trading Volume for 2019",
    x = "Months",
    y = "Quantities in MWh"
  )
```


